name: Build and Deploy to AWS
on:
  push:
    branches:
      - ckan-setup
env:
  PROJECT_NAME: wri-odp
  BRANCH_NAME: dev
permissions:
      id-token: write
      contents: read    
jobs:
  BuildAndPushImageToAWS:
    runs-on: ubuntu-latest
    steps:
      - name: Git clone the repository
        uses: actions/checkout@v3
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Print-assume-role
        run: aws sts get-caller-identity
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          mask-password: 'true'
      - name: Build, tag, and push docker image to Amazon ECR
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ckan-dev-ecr
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG ckan-deployment/ckan
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
      - name: Update values.yaml
        run: |
          echo $BRANCH_NAME
          cd ckan-deployment
          curl https://raw.githubusercontent.com/datopian/devops-tools/master/scripts/templater.sh > /tmp/templater.sh
          bash /tmp/templater.sh helm-templates/values.yaml.$BRANCH_NAME.template > helm-templates/values.yaml
          mkdir -p /home/runner/.kube
          aws eks --region ${{ secrets.AWS_REGION }} update-kubeconfig --name ${{ secrets.CLUSTER_NAME }} --dry-run > /home/runner/.kube/config
        env:
          GITHUB_SHA: '${{ github.sha }}'
      - name: 'Deploy'
        uses: 'datopian/helm@master'
        with:
          release: '${{ env.PROJECT_NAME }}-${{ env.BRANCH_NAME }}'
          namespace: '${{ env.PROJECT_NAME }}-${{ env.BRANCH_NAME }}'
          chart: 'ckan-deployment/helm-templates'
          helm: 'helm3'
          token: '${{ github.token }}'
          value-files: "ckan-deployment/helm-templates/values.yaml"
          timeout: '900s'
        env:
          KUBECONFIG_FILE: '/home/runner/.kube/config'

